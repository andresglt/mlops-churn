name: MLOps CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  build-train:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    env:
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
      AZURE_WORKSPACE_NAME: ${{ secrets.AZURE_WORKSPACE_NAME }}

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install deps
      run: |
        pip install -r requirements.txt
        pip install azureml-core mlflow dvc[azure]

    - name: Configure DVC Azure remote
      env:
        AZURE_ACCOUNT: ${{ secrets.AZURE_ACCOUNT }}
        AZURE_KEY: ${{ secrets.AZURE_KEY }}
      run: |
        dvc remote modify azure account_name "$AZURE_ACCOUNT"
        dvc remote modify azure account_key "$AZURE_KEY"

    - name: Pull data
      run: dvc pull

    - name: Reproduce pipeline
      run: dvc repro

    - name: Authenticate with Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Train and log in MLflow (Azure ML backend)
      run: python src/train.py

    - name: Push artifacts to DVC remote
      run: dvc push